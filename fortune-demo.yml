Transform: AWS::Serverless-2016-10-31

Resources:
  FortuneBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub fortune-cookie-bucket-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        # ðŸ”¹ Borra objetos despuÃ©s de 1 dÃ­a (evita costos)
        Rules:
          - Id: DeleteOldFiles
            Status: Enabled
            ExpirationInDays: 1

  FortuneLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: !Sub
        - Stack ${AWS::StackName} Function ${ResourceName}
        - ResourceName: FortuneLambda
      CodeUri: src/FortuneLambda
      Handler: handler.lambda_handler # âœ… CorrecciÃ³n del handler
      Runtime: python3.11
      MemorySize: 128 # ðŸ”¹ MÃ­nimo para evitar costos extra
      Timeout: 5 # ðŸ”¹ MÃ¡ximo 5 segundos
      Environment:
        Variables:
          FORTUNECOOKIES_TABLE_NAME: !Ref FortuneCookies
          FORTUNECOOKIES_TABLE_ARN: !GetAtt FortuneCookies.Arn
          FORTUNECOOKIES_BUCKET_NAME: !Ref FortuneBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FortuneCookies
        - S3WritePolicy:
            BucketName: !Ref FortuneBucket

  FortuneCookies:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: FortuneCookies
      BillingMode: PROVISIONED # ðŸ”¹ Evita costos de on-demand
      ProvisionedThroughput:
        ReadCapacityUnits: 1 # ðŸ”¹ MÃ¡ximo 1 lectura por segundo (gratis)
        WriteCapacityUnits: 1 # ðŸ”¹ MÃ¡ximo 1 escritura por segundo (gratis)
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH

Outputs:
  LambdaFunction:
    Description: Lambda Function For Fortune Cookies
    Value: !GetAtt FortuneLambda.Arn
  DynamoDBTable:
    Description: DynamoDB Table For Fortune Cookies
    Value: !Ref FortuneCookies
  S3Bucket:
    Description: S3 Bucket For Fortune Cookies
    Value: !Ref FortuneBucket